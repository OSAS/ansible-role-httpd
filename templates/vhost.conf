# {{ ansible_managed }}

<VirtualHost *:{{ port }}>
        ServerName {{ _website_domain }}
    {% if _force_tls and port|int == 80 %}
        RewriteEngine On
        # for lets encrypt automation
        RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
        RewriteCond %{HTTPS} off
        RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
        Include /etc/httpd/conf.d/{{ _website_domain }}.conf.d/letsencrypt.conf
    {% else %}
        Include /etc/httpd/conf.d/{{ _website_domain }}.conf.d/*conf
    {% endif %}

{% if port|int == 443 %}
        ErrorLog logs/{{ _website_domain }}_ssl_error.log
        CustomLog logs/{{ _website_domain }}_ssl_access.log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

        SSLEngine on
        SSLCertificateKeyFile /etc/pki/tls/private/{{ _website_domain }}.key
        SSLCertificateChainFile /etc/pki/tls/certs/{{ _website_domain }}.ca.crt
        SSLCertificateFile /etc/pki/tls/certs/{{ _website_domain }}.crt
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        <IfVersion >= 2.4>
        SSLUseStapling on
        SSLStaplingReturnResponderErrors off
        SSLStaplingResponderTimeout 5
        SSLStaplingCache shmcb:/run/httpd/ssl_stapling(32768)
        </IfVersion>
        # taken on https://wiki.mozilla.org/Security/Server_Side_TLS
        SSLCipherSuite  ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK
{% else %}
        ErrorLog logs/{{ _website_domain }}_error.log
        CustomLog logs/{{ _website_domain }}_access.log combined
{% endif %}

</VirtualHost>
